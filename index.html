<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Pok√©mon World: Big Update</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --grass: #6cc966;
            --grass-dark: #58a853;
            --tree-base: #2d6e32;
            --tree-light: #44a34b;
            --ui-bg: #f8f8f8;
            --ui-border: #303030;
            --xp-color: #3498db;
            --team-color: #9b59b6;
        }

        * { 
            box-sizing: border-box; 
            -webkit-touch-callout: none; 
            -webkit-user-select: none;
            touch-action: manipulation;
            image-rendering: pixelated;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; overflow: hidden;
            font-family: 'Press Start 2P', cursive; background-color: #111;
            display: flex; justify-content: center; align-items: center;
        }

        #game-container {
            position: relative;
            width: 100vw; height: 100vh;
            max-width: 800px; max-height: 600px;
            background-color: #000;
            border: 4px solid #333;
            overflow: hidden;
        }

        #game-viewport { 
            position: relative; width: 100%; height: 100%; 
            overflow: hidden; outline: none; background: #222;
        }

        #camera-track {
            position: absolute;
            will-change: transform;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #world { position: absolute; }
        .tile { position: absolute; width: 64px; height: 64px; }
        
        .grass { 
            background-color: var(--grass); 
            background-image: 
                linear-gradient(45deg, var(--grass-dark) 25%, transparent 25%, transparent 75%, var(--grass-dark) 75%, var(--grass-dark)),
                linear-gradient(45deg, var(--grass-dark) 25%, transparent 25%, transparent 75%, var(--grass-dark) 75%, var(--grass-dark));
            background-size: 32px 32px;
            background-position: 0 0, 16px 16px;
            opacity: 0.8;
        }

        /* Map Decorations */
        .flower::after {
            content: ''; position: absolute; top: 20px; left: 20px;
            width: 8px; height: 8px; background: pink;
            border-radius: 50%;
            box-shadow: 12px 12px 0 yellow, -10px 15px 0 white;
            opacity: 0.7;
        }
        .pebble::after {
            content: ''; position: absolute; top: 40px; left: 10px;
            width: 6px; height: 4px; background: #444;
            border-radius: 2px;
            box-shadow: 20px -20px 0 #555;
            opacity: 0.6;
        }

        .wall { 
            background-color: var(--tree-base);
            border-radius: 50%;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            background-image: radial-gradient(circle at 30% 30%, var(--tree-light), transparent);
            transform: scale(1.1);
            z-index: 1;
        }

        .player-entity { 
            position: absolute; width: 64px; height: 64px; 
            display: flex; flex-direction: column; align-items: center; 
            transition: left 0.3s linear, top 0.3s linear;
            cursor: pointer;
        }

        .player-label { 
            background: rgba(255,255,255,0.9); color: #333; font-size: 6px; 
            padding: 3px 6px; border: 2px solid #303030; margin-bottom: 4px;
            position: absolute; top: -35px; white-space: nowrap; border-radius: 4px;
            z-index: 10; text-align: center; line-height: 1.2;
        }
        
        .team-tag {
            color: var(--team-color);
            font-weight: bold;
            display: block;
            margin-bottom: 2px;
        }
        
        .shiny-star {
            color: gold; text-shadow: 0 0 2px orange;
            animation: spin 1s infinite linear;
            display: inline-block;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .chat-bubble {
            background: #fff; border: 2px solid #000; border-radius: 8px;
            padding: 5px 8px; position: absolute; top: -65px;
            font-size: 8px; color: #000; white-space: nowrap;
            display: none; z-index: 20; box-shadow: 2px 2px rgba(0,0,0,0.2);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .chat-bubble::after {
            content: ''; position: absolute; bottom: -4px; left: 50%;
            margin-left: -4px; border-width: 4px 4px 0; border-style: solid;
            border-color: #000 transparent transparent transparent;
        }

        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .sprite-img { width: 64px; height: 64px; object-fit: contain; z-index: 5; position: relative; }

        #battle-overlay {
            background: #ffffff; /* Fundo Branco */
            display: none; flex-direction: column; padding: 10px; z-index: 2000;
        }
        
        /* Removed extra background elements */
        #battle-overlay::before, #battle-overlay::after { display: none; }

        .battle-scene { flex: 1; position: relative; }
        .poke-container { position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
        
        /* Base de Grama Redonda */
        .poke-container::after {
            content: ''; 
            position: absolute; 
            bottom: 0px; 
            width: 120%; 
            height: 40px;
            background-color: #71b16a;
            background-image: radial-gradient(circle at 40% 40%, #8cd182 0%, #71b16a 60%, #589652 100%);
            border: 3px solid #3c6e3c;
            border-radius: 50%; 
            z-index: 1;
            transform: translateY(15px);
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }

        #opp-container { top: 40px; right: 50px; width: 140px; height: 140px; }
        #my-container { bottom: 60px; left: 50px; width: 180px; height: 180px; }
        .poke-battle-img { width: 100%; height: 100%; object-fit: contain; z-index: 2; position: relative; animation: float 3s infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        .battle-info { background: #fff; border: 3px solid #333; padding: 6px; width: 160px; border-radius: 0 10px; position: absolute; z-index: 20; box-shadow: 3px 3px rgba(0,0,0,0.2); }
        .info-opp { top: 20px; left: 20px; }
        .info-my { bottom: 140px; right: 20px; }
        
        .hp-bar, .xp-bar { width: 100%; height: 100%; background: #eee; border: 2px solid #333; overflow: hidden; position: relative; }
        .hp-container, .xp-container { width: 100%; height: 8px; margin-top: 4px; position: relative; }
        .hp-fill { height: 100%; background: #4caf50; width: 100%; transition: width 0.4s; }
        .xp-fill { height: 100%; background: var(--xp-color); width: 0%; transition: width 0.6s; }
        .bar-text { position: absolute; inset: 0; font-size: 5px; color: #000; display: flex; align-items: center; justify-content: center; font-weight: bold; pointer-events: none; }

        #mobile-controls { 
            position: absolute; bottom: 30px; left: 30px; 
            display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(2, 60px); 
            gap: 5px; z-index: 800; opacity: 0.8;
        }
        .d-btn { 
            background: rgba(255,255,255,0.9); border: 2px solid #333; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; cursor: pointer; border-radius: 10px; 
            box-shadow: 0 4px #444; transition: transform 0.1s;
            user-select: none;
        }
        .d-btn:active { transform: translateY(4px); box-shadow: 0 0 #666; background: #ddd; }

        #emote-bar { position: absolute; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 800; }
        .emote-btn { background: #fff; border: 2px solid #333; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 3px rgba(0,0,0,0.3); }

        .overlay { position: absolute; inset: 0; background: var(--ui-bg); z-index: 1000; display: none; flex-direction: column; padding: 20px; border: 8px double var(--ui-border); }
        .btn { background: #fff; border: 4px solid #333; padding: 12px; font-family: 'Press Start 2P'; font-size: 10px; cursor: pointer; margin: 4px; }
        .btn:hover { background: #eee; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .dex-entry {
            background: #fff;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px;
            font-size: 8px;
            cursor: pointer;
            box-shadow: 2px 2px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .dex-entry:hover {
            transform: translateY(-2px);
            background: #f0f0f0;
        }

        .wild-ball { position: absolute; width: 64px; height: 64px; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 10; animation: bounce 0.6s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-6px); } }

        #evo-overlay { 
            position: absolute; inset: 0; z-index: 3000; 
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; 
            background: radial-gradient(circle, #2a2a2a 0%, #000 100%);
        }
        .evo-bg-particles {
            position: absolute; inset: 0; pointer-events: none;
            background-image: radial-gradient(white 2px, transparent 2px);
            background-size: 50px 50px;
            opacity: 0.1;
            animation: evo-bg-spin 10s linear infinite;
        }
        @keyframes evo-bg-spin { 0% { transform: rotate(0deg) scale(1.5); } 100% { transform: rotate(360deg) scale(1.5); } }
        .evo-pulse { animation: evoPulseAnim 1.5s infinite; filter: brightness(100) drop-shadow(0 0 10px white); }
        @keyframes evoPulseAnim { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .white-flash-screen {
            position: absolute; inset: 0; background: white; z-index: 3005;
            animation: flashFade 1s forwards; pointer-events: none;
        }
        @keyframes flashFade { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        .evo-reveal { animation: revealAnim 2s forwards; }
        @keyframes revealAnim { 0% { filter: brightness(100); } 100% { filter: brightness(1); } }
        .confetti {
            position: absolute; width: 10px; height: 10px; background: #ffd700;
            animation: fall 2s linear forwards; z-index: 3002;
        }
        @keyframes fall { to { transform: translateY(300px) rotate(720deg); opacity: 0; } }
        
        #online-count { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 8px; z-index: 900; pointer-events: none; }
    
        input[type="text"], input[type="number"], select, input[type="email"], input[type="password"] {
            font-family: 'Press Start 2P', cursive;
            padding: 10px;
            border: 4px solid #333;
            margin-bottom: 20px;
            font-size: 12px;
            width: 80%;
            text-align: center;
        }
        /* Auth specific styles */
        #auth-screen {
            position: absolute; inset: 0; z-index: 5000;
            background: #111; display: none; flex-direction: column;
            align-items: center; justify-content: center;
            color: white;
            background-image: radial-gradient(circle at center, #222 0%, #000 100%);
        }
        .auth-logo {
            font-size: 20px; color: #ffcc00; text-shadow: 4px 4px #2b6cb0;
            margin-bottom: 30px; text-align: center; line-height: 1.5;
        }
        .auth-box {
            background: #fff; padding: 20px; border-radius: 10px;
            border: 4px solid #333; display: flex; flex-direction: column;
            align-items: center; width: 300px;
        }
        
        /* Chat box style */
        #team-chat-box {
            flex: 1; width: 100%; background: #222; border: 2px solid #444;
            margin: 10px 0; padding: 10px; overflow-y: auto; color: white;
            font-size: 8px; font-family: monospace; display: flex; flex-direction: column; gap: 4px;
        }
        
        #capture-anim-layer {
            position: absolute; inset: 0; pointer-events: none; z-index: 2050; display: none;
        }
        
        /* Reverted to standard classes, animation now handled by JS for precision */
        .ball-throw-container {
            position: absolute;
            width: 48px; /* Aumentado de 24px para 48px */
            height: 48px; /* Aumentado de 24px para 48px */
            z-index: 2060;
        }
        
        .ball-visual {
            width: 100%; height: 100%;
            background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');
            background-size: contain; background-repeat: no-repeat;
        }

        .ball-bounce {
            animation: bounceGround 0.4s ease-out;
        }
        @keyframes bounceGround {
            0% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0); }
        }

        .ball-light {
            position: absolute; top: 50%; left: 50%;
            width: 4px; height: 4px; border-radius: 50%;
            background: #ff0000;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 5px red;
            display: none;
            z-index: 2061;
        }
        
        .shake-left { animation: shakeL 0.15s 3 alternate; }
        .shake-right { animation: shakeR 0.15s 3 alternate; }
        @keyframes shakeL { 0% { transform: rotate(0deg); } 100% { transform: rotate(-25deg); } }
        @keyframes shakeR { 0% { transform: rotate(0deg); } 100% { transform: rotate(25deg); } }

        .capture-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0;
            animation: flashBang 0.2s forwards;
            pointer-events: none;
            z-index: 2100;
        }
        @keyframes flashBang { 0% { opacity: 0.8; } 100% { opacity: 0; } }
        
        .energy-suck {
            animation: suckAnim 0.5s forwards ease-in;
            filter: sepia(1) hue-rotate(-50deg) saturate(5) brightness(1.2); 
        }
        @keyframes suckAnim {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.1); opacity: 0; }
        }

        #challenge-modal {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            background: #fff; border: 4px solid #333; padding: 15px;
            z-index: 2500; display: none; flex-direction: column; align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); text-align: center;
            width: 280px;
        }

        #fullscreen-btn {
            position: absolute; top: 10px; right: 10px;
            z-index: 950; background: rgba(0,0,0,0.5); color: white;
            border: 1px solid white; padding: 5px; font-size: 10px;
            cursor: pointer; display: none;
        }
        
        @media (max-width: 600px) {
            #mobile-controls { bottom: 20px; left: 10px; gap: 2px; }
            .d-btn { width: 50px; height: 50px; font-size: 18px; }
            #emote-bar { bottom: 20px; right: 10px; }
            #hud-stats { top: 40px; right: 10px; }
            .battle-info { width: 120px; font-size: 8px; }
            #opp-container { width: 100px; height: 100px; top: 50px; right: 20px; }
            #my-container { width: 120px; height: 120px; bottom: 80px; left: 20px; }
            .auth-box { width: 90%; }
        }
        
        .crit-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: yellow; font-size: 16px; font-weight: bold; text-shadow: 2px 2px red;
            z-index: 100; animation: critPop 0.5s forwards; pointer-events: none;
        }
        @keyframes critPop { 0% { transform: translate(-50%, -50%) scale(0); } 50% { transform: translate(-50%, -50%) scale(1.5); } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
    </style>
</head>
<body>

<div id="loading-screen" style="position:fixed; inset:0; background:#fff; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div style="font-size: 12px; margin-bottom: 20px;">POK√âMON MMO</div>
    <div id="loading-text" style="font-size: 8px; color: #666;">CONECTANDO...</div>
</div>

<!-- TELA DE LOGIN -->
<div id="auth-screen">
    <div class="auth-logo">POK√âMON<br>WORLD ONLINE</div>
    <div class="auth-box">
        <!-- Changed to Text input for Username -->
        <input type="text" id="auth-username" placeholder="NOME DE USU√ÅRIO" maxlength="15" style="width:100%; color:black; text-transform:uppercase;">
        <input type="password" id="auth-pass" placeholder="SENHA" style="width:100%; color:black;">
        <div style="display:flex; gap:10px; margin-top:10px; width:100%; justify-content: center;">
            <button class="btn" style="background:#4caf50; color:white; flex:1;" onclick="tryLogin()">ENTRAR</button>
            <button class="btn" style="background:#3498db; color:white; flex:1;" onclick="tryRegister()">CRIAR</button>
        </div>
        <div id="auth-error" style="color:red; font-size:8px; margin-top:10px; text-align:center; min-height:10px;"></div>
    </div>
</div>

<div id="game-container">
    <div id="online-count">Online: 1</div>
    <button id="fullscreen-btn" onclick="toggleFullScreen()">FULLSCREEN</button>
    
    <div id="game-viewport" tabindex="0">
        <div id="camera-track">
            <div id="world"></div>
            <div id="wild-layer"></div>
            <div id="entities-layer">
                <div id="player-local" class="player-entity" style="display: none;">
                    <div id="chat-bubble-local" class="chat-bubble"></div>
                    <div id="p-label-local" class="player-label">VOC√ä</div>
                    <img class="sprite-img" id="my-sprite">
                </div>
            </div>
        </div>

        <div id="mobile-controls">
            <div style="grid-column: 2" class="d-btn" onmousedown="handleMove('up')" ontouchstart="handleMove('up'); event.preventDefault();">‚ñ≤</div>
            <div style="grid-row: 2; grid-column: 1" class="d-btn" onmousedown="handleMove('left')" ontouchstart="handleMove('left'); event.preventDefault();">‚óÄ</div>
            <div style="grid-row: 2; grid-column: 2" class="d-btn" onmousedown="handleMove('down')" ontouchstart="handleMove('down'); event.preventDefault();">‚ñº</div>
            <div style="grid-row: 2; grid-column: 3" class="d-btn" onmousedown="handleMove('right')" ontouchstart="handleMove('right'); event.preventDefault();">‚ñ∂</div>
        </div>

        <div id="emote-bar">
            <div class="emote-btn" onclick="sendEmote('Ol√°!')">üëã</div>
            <div class="emote-btn" onclick="sendEmote('Batalha?')">‚öîÔ∏è</div>
            <div class="emote-btn" onclick="sendEmote('Legal!')">üòé</div>
            <div class="emote-btn" onclick="sendEmote('Ajuda!')">üÜò</div>
             <div class="emote-btn" onclick="sendEmote('Vou ganhar')">üòÇ</div>
        </div>

        <div style="position: absolute; top: 15px; right: 15px; z-index: 600; display: flex; flex-direction: column; gap: 5px; align-items: flex-end;">
            <div id="hud-stats" style="background: white; border: 2px solid #333; padding: 4px; font-size: 7px;">LV: ...</div>
            <div class="xp-container" style="width: 120px;"><div class="xp-bar"><div id="hud-xp-fill" class="xp-fill"></div></div></div>
            <div id="team-bonus-indicator" style="display:none; color: gold; font-size: 7px; background: rgba(0,0,0,0.7); padding: 2px 4px; border-radius: 4px; margin-top: 2px;">üõ°Ô∏è B√îNUS EQUIPE</div>
            <div style="display:flex; gap:5px; flex-wrap: wrap; justify-content: flex-end;">
                <button class="btn" style="background:#4caf50; color:white; padding: 5px; font-size: 8px;" onclick="healPokemon()">DESCANSAR</button>
                <button class="btn" style="background:#3498db; color:white; padding: 5px; font-size: 8px;" onclick="toggleUI('team-overlay')">EQUIPE</button>
                <button class="btn" style="background:#ff5555; color:white; padding: 5px; font-size: 8px;" onclick="toggleUI('pokedex-overlay')">POK√âDEX</button>
                <button class="btn" style="background:#333; color:white; padding: 5px; font-size: 8px;" onclick="doLogout()">SAIR</button>
            </div>
        </div>

        <div id="start-screen" class="overlay">
            <h1 style="font-size: 10px; text-align: center;">BEM-VINDO TREINADOR</h1>
            <p id="welcome-nick-text" style="font-size:8px; margin-bottom:10px; color:#4a90e2;"></p>
            <p style="font-size:8px; margin-bottom:10px;">ESCOLHA SEU INICIAL:</p>
            <div id="starter-list" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:20px;"></div>
        </div>

        <div id="challenge-modal">
            <div id="challenge-msg" style="font-size: 8px; margin-bottom: 10px;">JOGADOR DESAFIOU VOC√ä!</div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="background: #84c57d;" onclick="acceptChallenge()">ACEITAR</button>
                <button class="btn" style="background: #ff5555;" onclick="rejectChallenge()">RECUSAR</button>
            </div>
        </div>

        <div id="pokedex-overlay" class="overlay">
            <h2 style="font-size: 10px;">POK√âDEX</h2>
            <div id="pokedex-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap:10px; overflow-y:auto; flex:1;"></div>
            <button class="btn" style="margin-top: 15px;" onclick="toggleUI('pokedex-overlay')">VOLTAR</button>
        </div>
        
        <!-- TEAM OVERLAY -->
        <div id="team-overlay" class="overlay">
            <h2 style="font-size: 12px; color: var(--team-color);">EQUIPE</h2>
            <div id="team-login-panel" style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-top:20px;">
                <p style="font-size:8px; text-align:center; line-height:1.5;">DIGITE O NOME DA EQUIPE<br>PARA CRIAR OU ENTRAR:</p>
                <input type="text" id="team-input-name" placeholder="NOME DA EQUIPE" maxlength="10">
                <button class="btn" style="background:var(--team-color); color:white;" onclick="joinTeam()">ENTRAR</button>
            </div>
            <div id="team-active-panel" style="display:none; flex-direction:column; height:100%;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span id="my-team-name" style="color: var(--team-color); font-weight:bold;">NOME</span>
                    <button class="btn" style="padding:4px; font-size:6px; background:#ff5555; color:white;" onclick="leaveTeam()">SAIR</button>
                </div>
                <div style="font-size:7px; color:#666; margin-bottom:5px;">CHAT DA EQUIPE:</div>
                <div id="team-chat-box"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="team-chat-input" placeholder="MENSAGEM..." style="flex:1; margin-bottom:0; font-size:8px;">
                    <button class="btn" style="padding:8px;" onclick="sendTeamMessage()">‚û§</button>
                </div>
            </div>
            <button class="btn" style="margin-top: 15px;" onclick="toggleUI('team-overlay')">VOLTAR</button>
        </div>

        <div id="battle-overlay" class="overlay">
            <div id="capture-anim-layer"></div>
            <div class="battle-scene">
                <div id="battle-turn-indicator" style="position:absolute; top:5px; left:0; right:0; text-align:center; font-size:8px; color:white; text-shadow:1px 1px 0 #000; z-index:50;"></div>
                <div class="battle-info info-opp">
                    <div id="opp-name" style="font-size: 7px;">OPONENTE</div>
                    <div id="opp-lv" style="font-size: 6px; margin-top: 2px;">LV: 1</div>
                    <div class="hp-container"><div class="hp-bar"><div id="opp-hp-fill" class="hp-fill"></div><div class="bar-text" id="opp-hp-text">100/100</div></div></div>
                </div>
                <div id="opp-container" class="poke-container">
                    <img id="opp-sprite" class="poke-battle-img">
                </div>
                <div id="my-container" class="poke-container">
                    <img id="my-battle-sprite" class="poke-battle-img">
                </div>
                <div class="battle-info info-my">
                    <div id="my-name-display" style="font-size: 7px;">VOC√ä</div>
                    <div id="my-lv-display" style="font-size: 6px; margin-top: 2px;">LV: 1</div>
                    <div class="hp-container"><div class="hp-bar"><div id="my-hp-fill" class="hp-fill"></div><div class="bar-text" id="my-hp-text">100/100</div></div></div>
                </div>
            </div>
            <div id="battle-log" style="background: #333; color: #fff; padding: 12px; font-size: 8px; min-height: 60px; line-height: 1.4;"></div>
            <div id="battle-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;">
                <button id="btn-attack" class="btn" onclick="performAttack()">LUTAR</button>
                <button id="btn-capture" class="btn" style="background:#ffcc00;" onclick="performCapture()">CAPTURAR</button>
                <button id="btn-run" class="btn" onclick="performRun()">FUGIR</button>
            </div>
        </div>

        <div id="evo-overlay" class="overlay">
            <div class="evo-bg-particles"></div>
            <h2 id="evo-text" style="color: white; text-shadow: 2px 2px 0 black; z-index: 3010; margin-bottom: 40px;">SEU POK√âMON EST√Å EVOLUINDO!</h2>
            <div style="position: relative; height: 180px; width: 180px; margin: 20px auto; z-index: 3001;">
                <img id="evo-img-main" style="width: 100%; height: 100%; object-fit: contain;">
            </div>
            <p id="evo-result" style="font-size: 10px; color: white; text-shadow: 1px 1px 0 black; z-index: 3010; margin-top: 20px;"></p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, updateDoc, deleteDoc, serverTimestamp, addDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let firebaseConfig;
    try {
        firebaseConfig = JSON.parse(__firebase_config);
    } catch (e) {
        firebaseConfig = { 
            apiKey: "AIzaSyCN9iZvaHoS-kOLEORfHGUgqb-jIR3UL4I",
            authDomain: "p004001025150.firebaseapp.com",
            projectId: "p004001025150",
            storageBucket: "p004001025150.firebasestorage.app",
            messagingSenderId: "274870436214",
            appId: "1:274870436214:web:07e72ac4ea1e9541797a57",
            measurementId: "G-MVXCN0RJ1F"
        };
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'pokemon-mmo-v3';

    const TILE_SIZE = 64;
    const GRID_SIZE = 40;
    const XP_PER_LEVEL = 100;

    // --- Stats & Data (EXPANDED) ---
    const baseStats = {
        'Bulbasaur': { hp: 45, atk: 49, def: 49 }, 'Ivysaur': { hp: 60, atk: 62, def: 63 }, 'Venusaur': { hp: 80, atk: 82, def: 83 },
        'Charmander': { hp: 39, atk: 52, def: 43 }, 'Charmeleon': { hp: 58, atk: 64, def: 58 }, 'Charizard': { hp: 78, atk: 84, def: 78 },
        'Squirtle': { hp: 44, atk: 48, def: 65 }, 'Wartortle': { hp: 59, atk: 63, def: 80 }, 'Blastoise': { hp: 79, atk: 83, def: 100 },
        'Caterpie': { hp: 45, atk: 30, def: 35 }, 'Metapod': { hp: 50, atk: 20, def: 55 }, 'Butterfree': { hp: 60, atk: 45, def: 50 },
        'Weedle': { hp: 40, atk: 35, def: 30 }, 'Kakuna': { hp: 45, atk: 25, def: 50 }, 'Beedrill': { hp: 65, atk: 90, def: 40 },
        'Pidgey': { hp: 40, atk: 45, def: 40 }, 'Pidgeotto': { hp: 63, atk: 60, def: 55 }, 'Pidgeot': { hp: 83, atk: 80, def: 75 },
        'Rattata': { hp: 30, atk: 56, def: 35 }, 'Raticate': { hp: 55, atk: 81, def: 60 },
        'Pikachu': { hp: 35, atk: 55, def: 40 }, 'Raichu': { hp: 60, atk: 90, def: 55 },
        'Jigglypuff': { hp: 115, atk: 45, def: 20 }, 'Wigglytuff': { hp: 140, atk: 70, def: 45 },
        'Zubat': { hp: 40, atk: 45, def: 35 }, 'Golbat': { hp: 75, atk: 80, def: 70 },
        'Meowth': { hp: 40, atk: 45, def: 35 }, 'Persian': { hp: 65, atk: 70, def: 60 },
        'Psyduck': { hp: 50, atk: 52, def: 48 }, 'Golduck': { hp: 80, atk: 82, def: 78 },
        'Growlithe': { hp: 55, atk: 70, def: 45 }, 'Arcanine': { hp: 90, atk: 110, def: 80 },
        'Abra': { hp: 25, atk: 20, def: 15 }, 'Kadabra': { hp: 40, atk: 35, def: 30 }, 'Alakazam': { hp: 55, atk: 50, def: 45 },
        'Machop': { hp: 70, atk: 80, def: 50 }, 'Machoke': { hp: 80, atk: 100, def: 70 }, 'Machamp': { hp: 90, atk: 130, def: 80 },
        'Geodude': { hp: 40, atk: 80, def: 100 }, 'Graveler': { hp: 55, atk: 95, def: 115 }, 'Golem': { hp: 80, atk: 120, def: 130 },
        'Gastly': { hp: 30, atk: 35, def: 30 }, 'Haunter': { hp: 45, atk: 50, def: 45 }, 'Gengar': { hp: 60, atk: 65, def: 60 },
        'Onix': { hp: 35, atk: 45, def: 160 }, 'Steelix': { hp: 75, atk: 85, def: 200 },
        'Cubone': { hp: 50, atk: 50, def: 95 }, 'Marowak': { hp: 60, atk: 80, def: 110 },
        'Magikarp': { hp: 20, atk: 10, def: 55 }, 'Gyarados': { hp: 95, atk: 125, def: 79 },
        'Lapras': { hp: 130, atk: 85, def: 80 },
        'Eevee': { hp: 55, atk: 55, def: 50 }, 'Vaporeon': { hp: 130, atk: 65, def: 60 }, 'Espeon': { hp: 65, atk: 65, def: 60 }, 'Umbreon': { hp: 95, atk: 65, def: 110 },
        'Snorlax': { hp: 160, atk: 110, def: 65 },
        'Dragonite': { hp: 91, atk: 134, def: 95 },
        'Mewtwo': { hp: 106, atk: 110, def: 90 },
        // --- NEW ADDITIONS ---
        'NidoranF': { hp: 55, atk: 47, def: 52 }, 'Nidorina': { hp: 70, atk: 62, def: 67 }, 'Nidoqueen': { hp: 90, atk: 92, def: 87 },
        'NidoranM': { hp: 46, atk: 57, def: 40 }, 'Nidorino': { hp: 61, atk: 72, def: 57 }, 'Nidoking': { hp: 81, atk: 102, def: 77 },
        'Clefairy': { hp: 70, atk: 45, def: 48 }, 'Clefable': { hp: 95, atk: 70, def: 73 },
        'Vulpix': { hp: 38, atk: 41, def: 40 }, 'Ninetales': { hp: 73, atk: 76, def: 75 },
        'Oddish': { hp: 45, atk: 50, def: 55 }, 'Gloom': { hp: 60, atk: 65, def: 70 }, 'Vileplume': { hp: 75, atk: 80, def: 85 },
        'Paras': { hp: 35, atk: 70, def: 55 }, 'Parasect': { hp: 60, atk: 95, def: 80 },
        'Venonat': { hp: 60, atk: 55, def: 50 }, 'Venomoth': { hp: 70, atk: 65, def: 60 },
        'Diglett': { hp: 10, atk: 55, def: 25 }, 'Dugtrio': { hp: 35, atk: 80, def: 50 },
        'Mankey': { hp: 40, atk: 80, def: 35 }, 'Primeape': { hp: 65, atk: 105, def: 60 },
        'Poliwag': { hp: 40, atk: 50, def: 40 }, 'Poliwhirl': { hp: 65, atk: 65, def: 65 }, 'Poliwrath': { hp: 90, atk: 95, def: 95 },
        'Bellsprout': { hp: 50, atk: 75, def: 35 }, 'Weepinbell': { hp: 65, atk: 90, def: 50 }, 'Victreebel': { hp: 80, atk: 105, def: 65 },
        'Tentacool': { hp: 40, atk: 40, def: 35 }, 'Tentacruel': { hp: 80, atk: 70, def: 65 },
        'Ponyta': { hp: 50, atk: 85, def: 55 }, 'Rapidash': { hp: 65, atk: 100, def: 70 },
        'Slowpoke': { hp: 90, atk: 65, def: 65 }, 'Slowbro': { hp: 95, atk: 75, def: 110 },
        'Magnemite': { hp: 25, atk: 35, def: 70 }, 'Magneton': { hp: 50, atk: 60, def: 95 },
        'Doduo': { hp: 35, atk: 85, def: 45 }, 'Dodrio': { hp: 60, atk: 110, def: 70 },
        'Seel': { hp: 65, atk: 45, def: 55 }, 'Dewgong': { hp: 90, atk: 70, def: 80 },
        'Grimer': { hp: 80, atk: 80, def: 50 }, 'Muk': { hp: 105, atk: 105, def: 75 },
        'Shellder': { hp: 30, atk: 65, def: 100 }, 'Cloyster': { hp: 50, atk: 95, def: 180 },
        'Drowzee': { hp: 60, atk: 48, def: 45 }, 'Hypno': { hp: 85, atk: 73, def: 70 },
        'Krabby': { hp: 30, atk: 105, def: 90 }, 'Kingler': { hp: 55, atk: 130, def: 115 },
        'Voltorb': { hp: 40, atk: 30, def: 50 }, 'Electrode': { hp: 60, atk: 50, def: 70 },
        'Exeggcute': { hp: 60, atk: 40, def: 80 }, 'Exeggutor': { hp: 95, atk: 95, def: 85 },
        'Hitmonlee': { hp: 50, atk: 120, def: 53 }, 'Hitmonchan': { hp: 50, atk: 105, def: 79 },
        'Koffing': { hp: 40, atk: 65, def: 95 }, 'Weezing': { hp: 65, atk: 90, def: 120 },
        'Rhyhorn': { hp: 80, atk: 85, def: 95 }, 'Rhydon': { hp: 105, atk: 130, def: 120 },
        'Chansey': { hp: 250, atk: 5, def: 5 },
        'Tangela': { hp: 65, atk: 55, def: 115 },
        'Kangaskhan': { hp: 105, atk: 95, def: 80 },
        'Horsea': { hp: 30, atk: 40, def: 70 }, 'Seadra': { hp: 55, atk: 65, def: 95 },
        'Goldeen': { hp: 45, atk: 67, def: 60 }, 'Seaking': { hp: 80, atk: 92, def: 65 },
        'Staryu': { hp: 30, atk: 45, def: 55 }, 'Starmie': { hp: 60, atk: 75, def: 85 },
        'Scyther': { hp: 70, atk: 110, def: 80 },
        'Jynx': { hp: 65, atk: 50, def: 35 },
        'Electabuzz': { hp: 65, atk: 83, def: 57 },
        'Magmar': { hp: 65, atk: 95, def: 57 },
        'Pinsir': { hp: 65, atk: 125, def: 100 },
        'Tauros': { hp: 75, atk: 100, def: 95 },
        'Porygon': { hp: 65, atk: 60, def: 70 },
        'Omanyte': { hp: 35, atk: 40, def: 100 }, 'Omastar': { hp: 70, atk: 60, def: 125 },
        'Kabuto': { hp: 30, atk: 80, def: 90 }, 'Kabutops': { hp: 60, atk: 115, def: 105 },
        'Aerodactyl': { hp: 80, atk: 105, def: 65 },
        'Dratini': { hp: 41, atk: 64, def: 45 }, 'Dragonair': { hp: 61, atk: 84, def: 65 },
        'Articuno': { hp: 90, atk: 85, def: 100 },
        'Zapdos': { hp: 90, atk: 90, def: 85 },
        'Moltres': { hp: 90, atk: 100, def: 90 },
        'Ditto': { hp: 48, atk: 48, def: 48 }
    };

    const evolutionMap = {
        'Bulbasaur': 'Ivysaur', 'Ivysaur': 'Venusaur',
        'Charmander': 'Charmeleon', 'Charmeleon': 'Charizard',
        'Squirtle': 'Wartortle', 'Wartortle': 'Blastoise',
        'Caterpie': 'Metapod', 'Metapod': 'Butterfree',
        'Weedle': 'Kakuna', 'Kakuna': 'Beedrill',
        'Pidgey': 'Pidgeotto', 'Pidgeotto': 'Pidgeot',
        'Rattata': 'Raticate',
        'Pikachu': 'Raichu',
        'Jigglypuff': 'Wigglytuff',
        'Zubat': 'Golbat',
        'Meowth': 'Persian',
        'Psyduck': 'Golduck',
        'Growlithe': 'Arcanine',
        'Abra': 'Kadabra', 'Kadabra': 'Alakazam',
        'Machop': 'Machoke', 'Machoke': 'Machamp',
        'Geodude': 'Graveler', 'Graveler': 'Golem',
        'Gastly': 'Haunter', 'Haunter': 'Gengar',
        'Onix': 'Steelix',
        'Cubone': 'Marowak',
        'Magikarp': 'Gyarados',
        'Eevee': 'Vaporeon',
        // --- EVOLUTION ADDITIONS ---
        'NidoranF': 'Nidorina', 'Nidorina': 'Nidoqueen',
        'NidoranM': 'Nidorino', 'Nidorino': 'Nidoking',
        'Clefairy': 'Clefable',
        'Vulpix': 'Ninetales',
        'Oddish': 'Gloom', 'Gloom': 'Vileplume',
        'Paras': 'Parasect',
        'Venonat': 'Venomoth',
        'Diglett': 'Dugtrio',
        'Mankey': 'Primeape',
        'Poliwag': 'Poliwhirl', 'Poliwhirl': 'Poliwrath',
        'Bellsprout': 'Weepinbell', 'Weepinbell': 'Victreebel',
        'Tentacool': 'Tentacruel',
        'Ponyta': 'Rapidash',
        'Slowpoke': 'Slowbro',
        'Magnemite': 'Magneton',
        'Doduo': 'Dodrio',
        'Seel': 'Dewgong',
        'Grimer': 'Muk',
        'Shellder': 'Cloyster',
        'Drowzee': 'Hypno',
        'Krabby': 'Kingler',
        'Voltorb': 'Electrode',
        'Exeggcute': 'Exeggutor',
        'Koffing': 'Weezing',
        'Rhyhorn': 'Rhydon',
        'Horsea': 'Seadra',
        'Goldeen': 'Seaking',
        'Staryu': 'Starmie',
        'Omanyte': 'Omastar',
        'Kabuto': 'Kabutops',
        'Dratini': 'Dragonair', 'Dragonair': 'Dragonite'
    };

    const spawnCategories = {
        basic: [
            'Bulbasaur', 'Charmander', 'Squirtle', 'Pikachu', 'Eevee', 'Psyduck', 'Snorlax', 'Lapras',
            'Caterpie', 'Weedle', 'Pidgey', 'Rattata', 'Zubat', 'Meowth', 'Abra', 'Machop', 'Geodude', 'Gastly', 'Magikarp', 'Cubone',
            // New Basics
            'NidoranF', 'NidoranM', 'Clefairy', 'Vulpix', 'Oddish', 'Paras', 'Venonat', 'Diglett', 'Mankey', 'Poliwag', 
            'Bellsprout', 'Tentacool', 'Ponyta', 'Slowpoke', 'Magnemite', 'Doduo', 'Seel', 'Grimer', 'Shellder', 'Drowzee',
            'Krabby', 'Voltorb', 'Exeggcute', 'Koffing', 'Rhyhorn', 'Horsea', 'Goldeen', 'Staryu', 'Ditto'
        ],
        rare: [
            'Gengar', 'Arcanine', 'Metapod', 'Kakuna', 'Pidgeotto', 'Raticate', 'Jigglypuff', 'Persian', 'Kadabra', 'Machoke', 'Graveler', 'Haunter', 'Onix', 'Marowak', 'Gyarados',
            // New Rares
            'Nidorina', 'Nidorino', 'Clefable', 'Ninetales', 'Gloom', 'Parasect', 'Venomoth', 'Dugtrio', 'Primeape', 'Poliwhirl',
            'Weepinbell', 'Tentacruel', 'Rapidash', 'Slowbro', 'Magneton', 'Dodrio', 'Dewgong', 'Muk', 'Cloyster', 'Hypno',
            'Kingler', 'Electrode', 'Exeggutor', 'Weezing', 'Rhydon', 'Seadra', 'Seaking', 'Starmie', 
            'Hitmonlee', 'Hitmonchan', 'Chansey', 'Tangela', 'Kangaskhan', 'Scyther', 'Jynx', 'Electabuzz', 'Magmar', 'Pinsir', 'Tauros', 'Porygon', 'Dratini', 'Dragonair',
            'Omanyte', 'Kabuto', 'Aerodactyl'
        ],
        legendary: [
            'Dragonite', 'Mewtwo', 'Butterfree', 'Beedrill', 'Pidgeot', 'Wigglytuff', 'Golbat', 'Alakazam', 'Machamp', 'Golem',
            // New Legendary Tier / Fully Evolved
            'Nidoqueen', 'Nidoking', 'Vileplume', 'Poliwrath', 'Victreebel', 'Omastar', 'Kabutops', 
            'Articuno', 'Zapdos', 'Moltres'
        ]
    };

    const pokeIDs = { 
        'Bulbasaur': 1, 'Ivysaur': 2, 'Venusaur': 3, 'Charmander': 4, 'Charmeleon': 5, 'Charizard': 6,
        'Squirtle': 7, 'Wartortle': 8, 'Blastoise': 9, 'Pikachu': 25, 'Raichu': 26, 'Eevee': 133, 'Vaporeon': 134,
        'Gengar': 94, 'Dragonite': 149, 'Mewtwo': 150, 'Snorlax': 143, 'Arcanine': 59, 'Lapras': 131, 'Psyduck': 54, 'Golduck': 55,
        'Caterpie': 10, 'Metapod': 11, 'Butterfree': 12,
        'Weedle': 13, 'Kakuna': 14, 'Beedrill': 15,
        'Pidgey': 16, 'Pidgeotto': 17, 'Pidgeot': 18,
        'Rattata': 19, 'Raticate': 20,
        'Jigglypuff': 39, 'Wigglytuff': 40,
        'Zubat': 41, 'Golbat': 42,
        'Meowth': 52, 'Persian': 53,
        'Growlithe': 58,
        'Abra': 63, 'Kadabra': 64, 'Alakazam': 65,
        'Machop': 66, 'Machoke': 67, 'Machamp': 68,
        'Geodude': 74, 'Graveler': 75, 'Golem': 76,
        'Gastly': 92, 'Haunter': 93,
        'Onix': 95, 'Steelix': 208,
        'Cubone': 104, 'Marowak': 105,
        'Magikarp': 129, 'Gyarados': 130,
        // --- NEW IDs ---
        'NidoranF': 29, 'Nidorina': 30, 'Nidoqueen': 31,
        'NidoranM': 32, 'Nidorino': 33, 'Nidoking': 34,
        'Clefairy': 35, 'Clefable': 36,
        'Vulpix': 37, 'Ninetales': 38,
        'Oddish': 43, 'Gloom': 44, 'Vileplume': 45,
        'Paras': 46, 'Parasect': 47,
        'Venonat': 48, 'Venomoth': 49,
        'Diglett': 50, 'Dugtrio': 51,
        'Mankey': 56, 'Primeape': 57,
        'Poliwag': 60, 'Poliwhirl': 61, 'Poliwrath': 62,
        'Bellsprout': 69, 'Weepinbell': 70, 'Victreebel': 71,
        'Tentacool': 72, 'Tentacruel': 73,
        'Ponyta': 77, 'Rapidash': 78,
        'Slowpoke': 79, 'Slowbro': 80,
        'Magnemite': 81, 'Magneton': 82,
        'Doduo': 84, 'Dodrio': 85,
        'Seel': 86, 'Dewgong': 87,
        'Grimer': 88, 'Muk': 89,
        'Shellder': 90, 'Cloyster': 91,
        'Drowzee': 96, 'Hypno': 97,
        'Krabby': 98, 'Kingler': 99,
        'Voltorb': 100, 'Electrode': 101,
        'Exeggcute': 102, 'Exeggutor': 103,
        'Hitmonlee': 106, 'Hitmonchan': 107,
        'Koffing': 109, 'Weezing': 110,
        'Rhyhorn': 111, 'Rhydon': 112,
        'Chansey': 113,
        'Tangela': 114,
        'Kangaskhan': 115,
        'Horsea': 116, 'Seadra': 117,
        'Goldeen': 118, 'Seaking': 119,
        'Staryu': 120, 'Starmie': 121,
        'Scyther': 123,
        'Jynx': 124,
        'Electabuzz': 125,
        'Magmar': 126,
        'Pinsir': 127,
        'Tauros': 128,
        'Porygon': 137,
        'Omanyte': 138, 'Omastar': 139,
        'Kabuto': 140, 'Kabutops': 141,
        'Aerodactyl': 142,
        'Articuno': 144,
        'Zapdos': 145,
        'Moltres': 146,
        'Dratini': 147, 'Dragonair': 148,
        'Ditto': 132
    };

    let currentUser = null;
    let myState = { 
        x: 20, y: 20, 
        nickname: 'Treinador',
        pokemon: '', 
        collection: [],
        shinies: [],
        level: 5, 
        xp: 0,
        hp: 100, 
        maxHp: 100,
        emote: '',
        battleInvite: null,
        team: ''
    };

    let remotePlayers = {};
    let activeBattle = false;
    let battleOpponent = null;
    let isMyTurn = true;
    let moveCooldown = false;
    let emoteTimeout = null;
    let pvpSubscription = null;
    let pendingInviteFrom = null;
    let teamChatSubscription = null;

    // --- AUTHENTICATION LOGIC ---

    const authScreen = document.getElementById('auth-screen');
    const loadingScreen = document.getElementById('loading-screen');
    const authError = document.getElementById('auth-error');

    function showError(msg) {
        authError.innerText = msg;
        setTimeout(() => authError.innerText = "", 3000);
    }

    // Initialize Anonymous Auth immediately
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (err) {
            console.error("Auth error", err);
            document.getElementById('loading-text').innerText = "ERRO CONEX√ÉO";
        }
    };
    initAuth();

    function sanitizeUser(user) {
        return user.trim().replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
    }

    window.tryLogin = async () => {
        const rawUser = document.getElementById('auth-username').value;
        const pass = document.getElementById('auth-pass').value;
        const user = sanitizeUser(rawUser);
        
        if (!user || !pass) return showError("PREENCHA NOME E SENHA");
        if (user.length < 3) return showError("NOME MUITO CURTO");

        // Check credentials in Firestore
        try {
            const accRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', user);
            const snap = await getDoc(accRef);
            
            if (!snap.exists()) {
                return showError("USU√ÅRIO N√ÉO ENCONTRADO");
            }
            
            const data = snap.data();
            if (data.password !== pass) {
                return showError("SENHA INCORRETA");
            }

            // Login Success
            myState.nickname = user;
            loadGameData(user);
        } catch(e) {
            console.error(e);
            showError("ERRO NO LOGIN");
        }
    };

    window.tryRegister = async () => {
        const rawUser = document.getElementById('auth-username').value;
        const pass = document.getElementById('auth-pass').value;
        const user = sanitizeUser(rawUser);

        if (!user || !pass) return showError("PREENCHA NOME E SENHA");
        if (user.length < 3) return showError("NOME MUITO CURTO (MIN 3)");
        if (pass.length < 4) return showError("SENHA MUITO CURTA (MIN 4)");

        try {
            const accRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', user);
            const snap = await getDoc(accRef);
            
            if (snap.exists()) {
                return showError("USU√ÅRIO J√Å EXISTE");
            }

            // Create Account
            await setDoc(accRef, {
                password: pass,
                created: serverTimestamp()
            });

            // Login Success
            myState.nickname = user;
            authScreen.style.display = 'none';
            showStarterSelection();
        } catch (e) {
            console.error(e);
            showError("ERRO AO CRIAR CONTA");
        }
    };

    async function loadGameData(username) {
        authScreen.style.display = 'none';
        loadingScreen.style.display = 'flex';
        document.getElementById('loading-text').innerText = "CARREGANDO...";
        
        try {
            const savePath = doc(db, 'artifacts', appId, 'public', 'data', 'saves', username);
            const snap = await getDoc(savePath);
            
            if (snap.exists()) {
                const data = snap.data();
                myState = { ...myState, ...data };
                if (!myState.shinies) myState.shinies = []; 
                if (!myState.team) myState.team = '';
                if(myState.x < 1) myState.x = 20; if(myState.y < 1) myState.y = 20;
                startGame();
            } else {
                showStarterSelection();
            }
        } catch(e) {
            console.error(e);
            showStarterSelection();
        }
    }

    window.doLogout = async () => {
        location.reload();
    }

    // --- Main Logic ---

    onAuthStateChanged(auth, async (u) => {
        if (!u) return;
        currentUser = u;
        loadingScreen.style.display = 'none';
        authScreen.style.display = 'flex';
    });

    // --- Multiplayer System ---
    function setupMultiplayer() {
        if (!currentUser) return;
        updateCloudState();
        const playersRef = collection(db, 'artifacts', appId, 'public', 'data', 'players');
        
        onSnapshot(playersRef, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const id = change.doc.id;
                if (id === currentUser.uid) return;
                
                if (change.type === "removed") {
                    removePlayer(id);
                } else {
                    const data = change.doc.data();
                    updateRemotePlayer(id, data);
                }
            });
            updateOnlineCount();
            checkTeamBonus();
        });

        setInterval(() => {
            const now = Date.now();
            let changed = false;
            Object.keys(remotePlayers).forEach(id => {
                const el = remotePlayers[id];
                const lastSeen = parseInt(el.dataset.lastSeen || 0);
                if (now - lastSeen > 20000) {
                    removePlayer(id);
                    changed = true;
                }
            });
            if (changed) {
                updateOnlineCount();
                checkTeamBonus();
            }
        }, 5000);
        
        setInterval(() => {
             updateCloudState();
        }, 10000);
    }

    let lastCloudUpdate = 0;
    async function updateCloudState() {
        if (!currentUser) return;
        const now = Date.now();
        if (now - lastCloudUpdate < 200) return;
        lastCloudUpdate = now;
        const playerRef = doc(db, 'artifacts', appId, 'public', 'data', 'players', currentUser.uid);
        try {
            await setDoc(playerRef, {
                x: myState.x,
                y: myState.y,
                nickname: myState.nickname || 'Treinador',
                pokemon: myState.pokemon,
                level: myState.level,
                emote: myState.emote || "",
                battleInvite: myState.battleInvite || null,
                isShiny: myState.shinies.includes(myState.pokemon),
                team: myState.team || "",
                timestamp: serverTimestamp()
            }, { merge: true });
        } catch(e) { console.error("Sync error", e); }
    }

    function updateRemotePlayer(id, data) {
        let el = document.getElementById(`player-${id}`);
        if (!el) {
            el = document.createElement('div');
            el.id = `player-${id}`;
            el.className = 'player-entity';
            el.innerHTML = `<div class="chat-bubble"></div><div class="player-label"></div><img class="sprite-img">`;
            document.getElementById('entities-layer').appendChild(el);
            remotePlayers[id] = el;
        }
        
        el.dataset.team = data.team || ""; // Store team in DOM for easy check
        
        if (data.timestamp) {
            el.dataset.lastSeen = data.timestamp.toMillis();
        } else {
            el.dataset.lastSeen = Date.now();
        }

        el.style.left = data.x * TILE_SIZE + 'px';
        el.style.top = data.y * TILE_SIZE + 'px';
        el.style.zIndex = data.y + 10;
        const nick = data.nickname || 'TREINADOR';
        
        let labelHTML = `<span class="team-tag">${data.team ? '['+data.team+']' : ''}</span>${nick}<br><span style="color:#666; font-size:5px;">LV.${data.level} ${data.pokemon}</span>`;
        
        el.querySelector('.player-label').innerHTML = labelHTML;
        const sprite = el.querySelector('.sprite-img');
        const newSrc = getSprite(data.pokemon, true, data.isShiny);
        if(sprite.src !== newSrc) sprite.src = newSrc;
        
        if (data.battleInvite === currentUser.uid && !activeBattle) {
            pendingInviteFrom = id;
            document.getElementById('challenge-msg').innerText = `${nick} QUER BATALHAR!`;
            document.getElementById('challenge-modal').style.display = 'flex';
        }
        el.onclick = () => sendChallenge(id, nick);
        const bubble = el.querySelector('.chat-bubble');
        if (data.emote && data.emote.trim() !== "") {
            bubble.innerText = data.emote;
            bubble.style.display = 'block';
        } else {
            bubble.style.display = 'none';
        }
    }

    function removePlayer(id) {
        const el = document.getElementById(`player-${id}`);
        if (el) el.remove();
        delete remotePlayers[id];
        updateOnlineCount();
    }
    
    function updateOnlineCount() {
        const total = Object.keys(remotePlayers).length + 1;
        document.getElementById('online-count').innerText = `Online: ${total}`;
    }

    // --- Team System Logic ---
    
    window.joinTeam = async () => {
        const input = document.getElementById('team-input-name');
        const teamName = input.value.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
        
        if (teamName.length < 3) {
            alert("Nome da equipe muito curto (min 3 letras)!");
            return;
        }
        
        myState.team = teamName;
        saveGame();
        updateCloudState();
        updateTeamUI();
        syncView(); // Refresh player label
        
        // Connect to chat
        setupTeamChat(teamName);
    };
    
    window.leaveTeam = async () => {
        myState.team = '';
        saveGame();
        updateCloudState();
        updateTeamUI();
        syncView();
        
        if (teamChatSubscription) {
            teamChatSubscription();
            teamChatSubscription = null;
        }
        document.getElementById('team-chat-box').innerHTML = '';
    };
    
    function updateTeamUI() {
        const loginPanel = document.getElementById('team-login-panel');
        const activePanel = document.getElementById('team-active-panel');
        
        if (myState.team) {
            loginPanel.style.display = 'none';
            activePanel.style.display = 'flex';
            document.getElementById('my-team-name').innerText = '[' + myState.team + ']';
            // Trigger chat load
            if (!teamChatSubscription) setupTeamChat(myState.team);
        } else {
            loginPanel.style.display = 'flex';
            activePanel.style.display = 'none';
        }
    }
    
    function setupTeamChat(teamName) {
        const chatRef = collection(db, 'artifacts', appId, 'public', 'data', 'team_chats', teamName, 'messages');
        const q = query(chatRef, orderBy('timestamp', 'desc'), limit(20));
        
        teamChatSubscription = onSnapshot(q, (snapshot) => {
            const box = document.getElementById('team-chat-box');
            box.innerHTML = '';
            const msgs = [];
            snapshot.forEach(doc => msgs.push(doc.data()));
            msgs.reverse().forEach(msg => {
                const line = document.createElement('div');
                line.style.color = msg.author === myState.nickname ? '#aaa' : '#fff';
                line.innerHTML = `<span style="color:${msg.author===myState.nickname?'#888':'#9b59b6'}">${msg.author}:</span> ${msg.text}`;
                box.appendChild(line);
            });
            box.scrollTop = box.scrollHeight;
        });
    }
    
    window.sendTeamMessage = async () => {
        if (!myState.team) return;
        const input = document.getElementById('team-chat-input');
        const text = input.value.trim();
        if (!text) return;
        
        const chatRef = collection(db, 'artifacts', appId, 'public', 'data', 'team_chats', myState.team, 'messages');
        await addDoc(chatRef, {
            author: myState.nickname,
            text: text,
            timestamp: serverTimestamp()
        });
        input.value = '';
    };

    function checkTeamBonus() {
        if (!myState.team) {
            document.getElementById('team-bonus-indicator').style.display = 'none';
            return false;
        }
        
        // Check if any remote player has the same team
        const hasTeammate = Object.values(remotePlayers).some(el => el.dataset.team === myState.team);
        
        const ind = document.getElementById('team-bonus-indicator');
        if (hasTeammate) {
            ind.style.display = 'block';
            return true;
        } else {
            ind.style.display = 'none';
            return false;
        }
    }

    // --- PVP Logic ---
    window.sendChallenge = async (targetId, targetName) => {
        if(activeBattle) return;
        if(!confirm(`Desafiar ${targetName} para uma batalha?`)) return;
        myState.battleInvite = targetId; 
        await updateCloudState();
        sendEmote("Desafiando...");
        const battleId = [currentUser.uid, targetId].sort().join('_'); 
        monitorBattleRoom(battleId, targetName);
    }

    window.acceptChallenge = async () => {
        if (!pendingInviteFrom) return;
        const challengerId = pendingInviteFrom;
        document.getElementById('challenge-modal').style.display = 'none';
        const battleId = [currentUser.uid, challengerId].sort().join('_');
        const battleRef = doc(db, 'artifacts', appId, 'public', 'data', 'battles', battleId);
        const myStats = calculateFullStats(myState.pokemon, myState.level);
        await setDoc(battleRef, {
            p1: challengerId, p2: currentUser.uid, turn: challengerId, status: 'active', log: 'Batalha come√ßou!', lastMoveTime: serverTimestamp(),
            [`data_${currentUser.uid}`]: { name: myState.nickname, pokemon: myState.pokemon, level: myState.level, hp: myStats.hp, maxHp: myStats.hp, def: myStats.def, isShiny: myState.shinies.includes(myState.pokemon) }
        });
        monitorBattleRoom(battleId, "OPONENTE");
        pendingInviteFrom = null;
    }

    window.rejectChallenge = () => {
        document.getElementById('challenge-modal').style.display = 'none';
        pendingInviteFrom = null;
    }

    function monitorBattleRoom(battleId, opponentNameDefault) {
        const battleRef = doc(db, 'artifacts', appId, 'public', 'data', 'battles', battleId);
        pvpSubscription = onSnapshot(battleRef, async (snap) => {
            if (!snap.exists()) {
                if (myState.battleInvite) document.getElementById('loading-text').innerText = "AGUARDANDO RESPOSTA...";
                return;
            }
            const data = snap.data();
            if (data.status === 'active' && !data[`data_${currentUser.uid}`]) {
                const myStats = calculateFullStats(myState.pokemon, myState.level);
                await updateDoc(battleRef, {
                    [`data_${currentUser.uid}`]: { name: myState.nickname, pokemon: myState.pokemon, level: myState.level, hp: myStats.hp, maxHp: myStats.hp, def: myStats.def, atk: myStats.atk, isShiny: myState.shinies.includes(myState.pokemon) }
                });
                return;
            }
            const opponentId = (currentUser.uid === data.p1) ? data.p2 : data.p1;
            const myData = data[`data_${currentUser.uid}`];
            const oppData = data[`data_${opponentId}`];
            if (myData && oppData) {
                if (!activeBattle) {
                    myState.battleInvite = null; 
                    updateCloudState();
                    startPvPVisual(oppData, battleId);
                }
                updatePvPUI(myData, oppData, data.turn, data.log);
                if (myData.hp <= 0 || oppData.hp <= 0) handlePvPEnd(myData, oppData, battleId);
            }
        });
    }

    function startPvPVisual(oppData, battleId) {
        activeBattle = true;
        battleOpponent = battleId; 
        document.getElementById('battle-overlay').style.display = 'flex';
        document.getElementById('opp-name').innerText = oppData.name;
        document.getElementById('opp-lv').innerText = `LV: ${oppData.level} (${oppData.pokemon})`;
        document.getElementById('opp-sprite').src = getSprite(oppData.pokemon, true, oppData.isShiny);
        document.getElementById('my-battle-sprite').src = getBackSprite(myState.pokemon, myState.shinies.includes(myState.pokemon));
        document.getElementById('my-name-display').innerText = myState.nickname;
        document.getElementById('my-lv-display').innerText = `LV: ${myState.level}`;
        document.getElementById('btn-capture').style.display = 'none';
        document.getElementById('btn-run').innerText = "RENDER-SE";
    }

    function updatePvPUI(me, opp, turnId, log) {
        const oppPct = (opp.hp / opp.maxHp) * 100;
        document.getElementById('opp-hp-fill').style.width = Math.max(0, oppPct) + '%';
        document.getElementById('opp-hp-text').innerText = `${Math.ceil(opp.hp)}/${opp.maxHp}`;
        const myPct = (me.hp / me.maxHp) * 100;
        document.getElementById('my-hp-fill').style.width = Math.max(0, myPct) + '%';
        document.getElementById('my-hp-text').innerText = `${Math.ceil(me.hp)}/${me.maxHp}`;
        document.getElementById('battle-log').innerText = log;
        isMyTurn = (turnId === currentUser.uid);
        const turnText = document.getElementById('battle-turn-indicator');
        if(isMyTurn) {
            turnText.innerText = "SUA VEZ!";
            document.getElementById('btn-attack').disabled = false;
            document.getElementById('btn-attack').style.opacity = '1';
        } else {
            turnText.innerText = `VEZ DE ${opp.name}`;
            document.getElementById('btn-attack').disabled = true;
            document.getElementById('btn-attack').style.opacity = '0.5';
        }
    }

    async function handlePvPEnd(me, opp, battleId) {
        if (pvpSubscription) pvpSubscription(); 
        pvpSubscription = null;
        activeBattle = false;
        if (me.hp > 0) {
            document.getElementById('battle-log').innerText = "VOC√ä VENCEU!";
            await addXP(50 + (opp.level * 5)); 
        } else {
            document.getElementById('battle-log').innerText = "VOC√ä PERDEU...";
            myState.hp = myState.maxHp;
        }
        setTimeout(() => {
             document.getElementById('battle-overlay').style.display = 'none';
             saveGame();
             updateCloudState();
        }, 3000);
    }

    // --- Game Logic ---
    function showStarterSelection() {
        document.getElementById('loading-screen').style.display = 'none';
        
        if (myState.nickname) {
            document.getElementById('welcome-nick-text').innerText = `OL√Å, ${myState.nickname}!`;
        }

        const starters = ['Bulbasaur', 'Charmander', 'Squirtle'];
        document.getElementById('starter-list').innerHTML = starters.map(name => `
            <div class="btn" onclick="chooseStarter('${name}')" style="text-align:center;">
                <img src="${getSprite(name, true)}" width="50"><br>${name}
            </div>
        `).join('');
        document.getElementById('start-screen').style.display = 'flex';
    }

    window.chooseStarter = async (name) => {
        if (!myState.nickname || myState.nickname === 'Treinador') {
             myState.nickname = 'TREINADOR';
        }
        
        myState.pokemon = name;
        myState.collection = [name];
        myState.shinies = [];
        myState.level = 5;
        myState.xp = 0;
        const stats = calculateFullStats(name, 5);
        myState.hp = stats.hp;
        myState.maxHp = stats.hp;
        myState.x = 18 + Math.floor(Math.random() * 4);
        myState.y = 18 + Math.floor(Math.random() * 4);
        await saveGame();
        document.getElementById('start-screen').style.display = 'none';
        startGame();
    };

    async function saveGame() {
        if (!currentUser) return;
        const savePath = doc(db, 'artifacts', appId, 'public', 'data', 'saves', myState.nickname);
        const { emote, battleInvite, ...saveData } = myState; 
        try { await setDoc(savePath, saveData); } catch(e) {}
    }

    function startGame() {
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('player-local').style.display = 'flex';
        generateMap();
        syncView(true);
        updateHUD();
        updateTeamUI(); // Check if already in team
        setupMultiplayer();
        setInterval(spawnWildItems, 5000);
        window.addEventListener('keydown', (e) => {
            if (activeBattle) return;
            // Prevent movement if typing in team chat
            if (document.activeElement === document.getElementById('team-chat-input')) return;
            if (document.activeElement === document.getElementById('team-input-name')) return;
            
            if (['ArrowUp', 'w'].includes(e.key)) handleMove('up');
            if (['ArrowDown', 's'].includes(e.key)) handleMove('down');
            if (['ArrowLeft', 'a'].includes(e.key)) handleMove('left');
            if (['ArrowRight', 'd'].includes(e.key)) handleMove('right');
        });
    }

    function generateMap() {
        const world = document.getElementById('world');
        world.innerHTML = '';
        const frag = document.createDocumentFragment();
        for (let y = 0; y < GRID_SIZE; y++) {
            for (let x = 0; x < GRID_SIZE; x++) {
                const div = document.createElement('div');
                let tileType = (x === 0 || y === 0 || x === GRID_SIZE - 1 || y === GRID_SIZE - 1 ? 'wall' : 'grass');
                
                // Add decorations (flowers and pebbles) to grass tiles randomly
                let decorationClass = '';
                if (tileType === 'grass') {
                    const r = Math.random();
                    if (r > 0.95) decorationClass = 'flower';
                    else if (r > 0.92) decorationClass = 'pebble';
                }

                div.className = `tile ${tileType} ${decorationClass}`;
                div.style.left = x * TILE_SIZE + 'px'; div.style.top = y * TILE_SIZE + 'px';
                frag.appendChild(div);
            }
        }
        world.appendChild(frag);
    }

    window.handleMove = (dir) => {
        if (activeBattle || moveCooldown) return;
        moveCooldown = true;
        setTimeout(() => moveCooldown = false, 150);
        let nx = myState.x, ny = myState.y;
        if (dir === 'up') ny--; if (dir === 'down') ny++; if (dir === 'left') nx--; if (dir === 'right') nx++;
        if (nx > 0 && nx < GRID_SIZE - 1 && ny > 0 && ny < GRID_SIZE - 1) {
            myState.x = nx; myState.y = ny; 
            syncView();
            updateCloudState();
        }
    };

    window.sendEmote = (msg) => {
        myState.emote = msg;
        const bubble = document.getElementById('chat-bubble-local');
        bubble.innerText = msg;
        bubble.style.display = 'block';
        updateCloudState();
        if (emoteTimeout) clearTimeout(emoteTimeout);
        emoteTimeout = setTimeout(() => {
            myState.emote = "";
            bubble.style.display = 'none';
            updateCloudState();
        }, 3000);
    };

    window.healPokemon = () => {
        if(activeBattle) return;
        myState.hp = myState.maxHp;
        sendEmote("Curando...");
        updateHUD();
        saveGame();
    }

    function syncView(immediate = false) {
        const p = document.getElementById('player-local');
        const track = document.getElementById('camera-track');
        const viewport = document.getElementById('game-viewport');
        if (immediate) track.style.transition = 'none';
        p.style.left = myState.x * TILE_SIZE + 'px';
        p.style.top = myState.y * TILE_SIZE + 'px';
        p.style.zIndex = myState.y + 10;
        document.getElementById('my-sprite').src = getSprite(myState.pokemon, true, myState.shinies.includes(myState.pokemon));
        const nick = myState.nickname || 'VOC√ä';
        
        let labelHTML = `<span class="team-tag">${myState.team ? '['+myState.team+']' : ''}</span>${nick}<br><span style="color:#666; font-size:5px;">LV.${myState.level} ${myState.pokemon}</span>`;
        document.getElementById('p-label-local').innerHTML = labelHTML;
        
        const cx = (viewport.offsetWidth / 2) - (myState.x * TILE_SIZE) - 32;
        const cy = (viewport.offsetHeight / 2) - (myState.y * TILE_SIZE) - 32;
        track.style.transform = `translate(${cx}px, ${cy}px)`;
        if (immediate) { track.offsetHeight; track.style.transition = ''; }
        
        // Re-check bonus since we moved
        checkTeamBonus();
    }
    
    // --- Helper Functions - UI ---
    
    function updateHUD() {
        document.getElementById('hud-stats').innerText = `LV:${myState.level} ${myState.pokemon} HP:${myState.hp}/${myState.maxHp}`;
        const pct = (myState.xp / XP_PER_LEVEL) * 100;
        document.getElementById('hud-xp-fill').style.width = pct + '%';
        
        const pokedex = document.getElementById('pokedex-overlay');
        if (pokedex.style.display === 'flex') {
            updatePokedexUI();
        }
    }
    
    window.toggleUI = (id) => {
        const el = document.getElementById(id);
        if (el.style.display === 'flex') {
            el.style.display = 'none';
        } else {
            el.style.display = 'flex';
            if(id === 'pokedex-overlay') updatePokedexUI();
        }
    };
    
    function updatePokedexUI() {
        const list = document.getElementById('pokedex-list');
        list.innerHTML = '';
        
        const allMons = Object.keys(pokeIDs).sort((a,b) => {
            const idA = pokeIDs[a] || 999;
            const idB = pokeIDs[b] || 999;
            return idA - idB;
        });
        
        allMons.forEach(name => {
            const isCaught = myState.collection.includes(name);
            const isShiny = myState.shinies.includes(name);

            const div = document.createElement('div');
            div.className = 'dex-entry';

            const img = document.createElement('img');
            
            if (isCaught) {
                img.src = getSprite(name, false, isShiny);
                img.style.filter = 'none';
            } else {
                img.src = getSprite(name, false, false);
                img.style.filter = 'brightness(0) opacity(0.5)';
            }

            img.style.width = '40px';
            img.style.height = '40px';
            
            const id = pokeIDs[name];
            const num = id.toString().padStart(3, '0');
            const numDiv = document.createElement('div');
            numDiv.style.fontSize = '5px';
            numDiv.style.color = '#666';
            numDiv.innerText = '#' + num;
            
            div.appendChild(numDiv);
            div.appendChild(img);
            
            const textDiv = document.createElement('div');
            textDiv.innerText = isCaught ? name : '???';
            div.appendChild(textDiv);

            list.appendChild(div);
        });
    }

    window.toggleFullScreen = () => {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(e => console.log(e));
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    };

    // --- Helper Functions ---
    function calculateFullStats(name, level) {
        const b = baseStats[name] || { hp: 50, atk: 50, def: 50 };
        let hp = Math.floor((b.hp * 2 * level) / 100) + level + 30;
        let atk = Math.floor((b.atk * 2 * level) / 100) + 5;
        let def = Math.floor((b.def * 2 * level) / 100) + 5;
        
        // TEAM BONUS: If teammate is nearby, increase stats by 10%
        if (checkTeamBonus()) {
            atk = Math.floor(atk * 1.1);
            def = Math.floor(def * 1.1);
        }
        
        return { hp, atk, def };
    }

    function calculateDamage(attackerLv, attackerAtk, defenderDef) {
        let damage = (((2 * attackerLv / 5 + 2) * attackerAtk * 90 / defenderDef) / 50) + 2;
        damage = damage * (Math.random() * (1 - 0.85) + 0.85);
        return Math.max(1, Math.floor(damage));
    }

    function getSprite(name, animated, shiny = false) {
        const id = pokeIDs[name] || 1;
        if (shiny) {
             return animated 
                ? `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/shiny/${id}.gif`
                : `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${id}.png`;
        }
        return animated 
            ? `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${id}.gif`
            : `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
    }
    
    function getBackSprite(name, shiny = false) {
        const id = pokeIDs[name] || 1;
        if (shiny) {
            return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/back/shiny/${id}.gif`;
        }
        return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/back/${id}.gif`;
    }

    // --- Battle & Spawning ---
    function spawnWildItems() {
        const layer = document.getElementById('wild-layer');
        if (layer.children.length > 5) return;
        
        const randType = Math.random();
        let ballType = 'poke-ball';
        let pool = spawnCategories.basic;
        let lvBonus = 0;

        if (randType > 0.95) { 
            ballType = 'ultra-ball';
            pool = Math.random() > 0.5 ? spawnCategories.legendary : spawnCategories.rare;
            lvBonus = 5; 
        } 
        else if (randType > 0.80) { 
            ballType = 'great-ball';
            pool = Math.random() > 0.3 ? spawnCategories.rare : spawnCategories.basic;
            lvBonus = 2;
        } 
        else {
            const rand = Math.random();
            if (rand > 0.98 && myState.level >= 20) pool = spawnCategories.legendary;
            else if (rand > 0.90 && myState.level >= 15) pool = spawnCategories.rare;
        }

        const name = pool[Math.floor(Math.random() * pool.length)];
        const rx = Math.max(1, Math.min(GRID_SIZE-2, myState.x + Math.floor(Math.random() * 10) - 5));
        const ry = Math.max(1, Math.min(GRID_SIZE-2, myState.y + Math.floor(Math.random() * 10) - 5));
        
        let lv = Math.max(1, myState.level + Math.floor(Math.random() * 4) + 1 + lvBonus);
        if (spawnCategories.legendary.includes(name)) lv = Math.max(30, lv);
        
        const isShiny = Math.random() < 0.02;

        const div = document.createElement('div');
        div.className = 'wild-ball';
        div.style.left = rx * TILE_SIZE + 'px'; div.style.top = ry * TILE_SIZE + 'px';
        
        let innerHTML = `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/${ballType}.png" width="32">`;
        if (isShiny) innerHTML += `<div class="shiny-star" style="position:absolute; top:-5px; right:-5px;">‚ú®</div>`;
        
        div.innerHTML = innerHTML;
        div.onclick = () => startWildBattle(name, lv, div, isShiny);
        layer.appendChild(div);
        setTimeout(() => { if(div.parentNode) div.remove(); }, 30000);
    }

    function startWildBattle(name, lv, el, isShiny) {
        if (activeBattle) return;
        activeBattle = true; isMyTurn = true;
        const myS = calculateFullStats(myState.pokemon, myState.level);
        myState.hp = myS.hp;
        myState.maxHp = myS.hp;
        const oppS = calculateFullStats(name, lv);
        battleOpponent = { name, level: lv, hp: oppS.hp, maxHp: oppS.hp, atk: oppS.atk, def: oppS.def, el, isShiny };

        document.getElementById('battle-overlay').style.display = 'flex';
        let nameHTML = name.toUpperCase();
        if(isShiny) nameHTML = `<span style="color:#FFD700">‚ú® ${nameHTML}</span>`;
        document.getElementById('opp-name').innerHTML = nameHTML;
        document.getElementById('opp-lv').innerText = `LV: ${lv}`;
        document.getElementById('opp-sprite').src = getSprite(name, true, isShiny);
        
        const oppSprite = document.getElementById('opp-sprite');
        oppSprite.className = 'poke-battle-img'; // reset class
        oppSprite.style.transform = 'scale(1)';
        oppSprite.style.opacity = '1';
        oppSprite.style.filter = 'none';

        document.getElementById('my-battle-sprite').src = getBackSprite(myState.pokemon, myState.shinies.includes(myState.pokemon));
        document.getElementById('my-name-display').innerText = myState.nickname || 'VOC√ä';
        document.getElementById('my-lv-display').innerText = `LV: ${myState.level}`;
        document.getElementById('btn-capture').style.display = 'block';
        document.getElementById('btn-run').innerText = "FUGIR";
        
        const btnAttack = document.getElementById('btn-attack');
        const btnCapture = document.getElementById('btn-capture');
        const btnRun = document.getElementById('btn-run');
        [btnAttack, btnCapture, btnRun].forEach(b => { b.disabled = false; b.style.opacity = '1'; b.style.pointerEvents = 'auto'; });

        document.getElementById('battle-turn-indicator').innerText = "SUA VEZ!";
        
        updateWildUI();
        document.getElementById('battle-log').innerText = `Um ${name} LV.${lv} selvagem apareceu!`;
    }

    function performWildAttack() {
        const myS = calculateFullStats(myState.pokemon, myState.level);
        let dmg = calculateDamage(myState.level, myS.atk, battleOpponent.def);
        let msg = `${myState.pokemon} atacou!`;
        
        if (Math.random() < 0.0625) {
            dmg *= 2;
            msg += " ACERTO CR√çTICO!";
            showCritAnim();
        }
        
        battleOpponent.hp -= dmg;
        updateWildUI();
        document.getElementById('battle-log').innerText = `${msg} causou ${dmg} dano.`;
        if (battleOpponent.hp <= 0) {
            setTimeout(() => {
                const xp = 15 + (battleOpponent.level * 5); 
                document.getElementById('battle-log').innerText = `Voc√™ venceu! +${xp} XP.`;
                addXP(xp);
                setTimeout(endBattle, 1500);
            }, 1000);
        } else {
            setTimeout(wildEnemyTurn, 1000);
        }
    }
    
    function showCritAnim() {
        const el = document.createElement('div');
        el.className = 'crit-text';
        el.innerText = 'CR√çTICO!';
        document.querySelector('.battle-scene').appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    function updateWildUI() {
        const oppPct = (battleOpponent.hp / battleOpponent.maxHp) * 100;
        document.getElementById('opp-hp-fill').style.width = Math.max(0, oppPct) + '%';
        document.getElementById('opp-hp-text').innerText = `${Math.ceil(battleOpponent.hp)}/${battleOpponent.maxHp}`;
        const myPct = (myState.hp / myState.maxHp) * 100;
        document.getElementById('my-hp-fill').style.width = Math.max(0, myPct) + '%';
        document.getElementById('my-hp-text').innerText = `${Math.ceil(myState.hp)}/${myState.maxHp}`;
    }

    window.performAttack = async () => {
        if (!isMyTurn || !activeBattle) return;
        isMyTurn = false;
        
        const btnAttack = document.getElementById('btn-attack');
        btnAttack.disabled = true;
        btnAttack.style.opacity = '0.5';

        if (typeof battleOpponent === 'string') {
            const battleRef = doc(db, 'artifacts', appId, 'public', 'data', 'battles', battleOpponent);
            const snap = await getDoc(battleRef);
            if(!snap.exists()) return;
            const data = snap.data();
            const opponentId = (currentUser.uid === data.p1) ? data.p2 : data.p1;
            const myData = data[`data_${currentUser.uid}`];
            const oppData = data[`data_${opponentId}`];
            const myStats = calculateFullStats(myData.pokemon, myData.level); 
            let dmg = calculateDamage(myData.level, myStats.atk, oppData.def);
            let critMsg = "";
            if (Math.random() < 0.0625) { dmg *= 2; critMsg = " (CR√çTICO!)"; showCritAnim(); }
            
            const newOppHp = Math.max(0, oppData.hp - dmg);
            await updateDoc(battleRef, { [`data_${opponentId}.hp`]: newOppHp, turn: opponentId, log: `${myData.pokemon} atacou!${critMsg} -${dmg} HP.` });
        } else {
            performWildAttack();
        }
    };

    function wildEnemyTurn() {
        if (!activeBattle || !battleOpponent) return;
        const myS = calculateFullStats(myState.pokemon, myState.level);
        let dmg = calculateDamage(battleOpponent.level, battleOpponent.atk, myS.def);
        let msg = `${battleOpponent.name} contra-atacou!`;
        if (Math.random() < 0.0625) {
             dmg *= 2;
             msg += " ACERTO CR√çTICO!";
             showCritAnim();
        }
        myState.hp -= dmg;
        updateWildUI();
        document.getElementById('battle-log').innerText = `${msg} ${dmg} de dano.`;
        if (myState.hp <= 0) {
            setTimeout(() => {
                document.getElementById('battle-log').innerText = "Seu Pok√©mon desmaiou...";
                setTimeout(endBattle, 1500);
            }, 1000);
        } else {
            isMyTurn = true;
            const btnAttack = document.getElementById('btn-attack');
            const btnCapture = document.getElementById('btn-capture');
            const btnRun = document.getElementById('btn-run');
            
            [btnAttack, btnCapture, btnRun].forEach(b => { 
                b.disabled = false; 
                b.style.opacity = '1'; 
                b.style.pointerEvents = 'auto'; 
            });

            document.getElementById('battle-turn-indicator').innerText = "SUA VEZ!";
        }
    }

    // --- UPDATED CAPTURE ANIMATION (FIXED POSITIONING) ---
    window.performCapture = async () => {
        if (!isMyTurn || !activeBattle) return;
        if (typeof battleOpponent === 'string') return; 
        isMyTurn = false;
        
        // Disable buttons
        const btnAttack = document.getElementById('btn-attack');
        const btnCapture = document.getElementById('btn-capture');
        const btnRun = document.getElementById('btn-run');
        [btnAttack, btnCapture, btnRun].forEach(b => { b.disabled = true; b.style.opacity = '0.5'; b.style.pointerEvents = 'none'; });

        document.getElementById('battle-log').innerText = "Lan√ßando Pok√©bola...";

        const layer = document.getElementById('capture-anim-layer');
        layer.innerHTML = '';
        layer.style.display = 'block';
        const oppSprite = document.getElementById('opp-sprite');

        // Create the Ball Structure
        const ballContainer = document.createElement('div');
        ballContainer.className = 'ball-throw-container';
        
        const ballVisual = document.createElement('div');
        ballVisual.className = 'ball-visual';
        
        const ballLight = document.createElement('div');
        ballLight.className = 'ball-light';
        
        ballVisual.appendChild(ballLight);
        ballContainer.appendChild(ballVisual);
        layer.appendChild(ballContainer);
        
        // Calculate Dynamic Start & End Points (Relative to layer)
        const mySprite = document.getElementById('my-battle-sprite');
        const myRect = mySprite.getBoundingClientRect();
        const oppRect = oppSprite.getBoundingClientRect();
        const layerRect = layer.getBoundingClientRect();

        // New Offset for larger ball (48px / 2 = 24px)
        const ballOffset = 24;

        // Start Center of Player Sprite
        const startX = (myRect.left + myRect.width / 2) - layerRect.left - ballOffset; 
        const startY = (myRect.top + myRect.height / 2) - layerRect.top - ballOffset;

        // End Center of Opponent Sprite
        const endX = (oppRect.left + oppRect.width / 2) - layerRect.left - ballOffset;
        const endY = (oppRect.top + oppRect.height / 2) - layerRect.top - ballOffset;
        
        // Midpoint for Arc (Mid X, Higher Y)
        const midX = (startX + endX) / 2;
        const midY = Math.min(startY, endY) - 150; // Go up 150px higher than highest point

        // Set Initial
        ballContainer.style.left = startX + 'px';
        ballContainer.style.top = startY + 'px';

        // 1. Throw Animation using WAAPI for precision arc
        const throwAnim = ballContainer.animate([
            { transform: `translate(0, 0) scale(1)` },
            { transform: `translate(${midX - startX}px, ${midY - startY}px) scale(1.2)`, offset: 0.5 },
            { transform: `translate(${endX - startX}px, ${endY - startY}px) scale(0.8)` }
        ], {
            duration: 800,
            easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
            fill: 'forwards'
        });
        
        // Spin while throwing
        const spinAnim = ballVisual.animate([
            { transform: 'rotate(0deg)' },
            { transform: 'rotate(720deg)' }
        ], { duration: 800, fill: 'forwards' });

        await throwAnim.finished;
        
        // Update position to end so we don't snap back when animation clears (though fill forwards handles it visually, good practice to set)
        ballContainer.style.left = endX + 'px';
        ballContainer.style.top = endY + 'px';

        // 2. Impact
        const flash = document.createElement('div');
        flash.className = 'capture-flash';
        document.querySelector('.battle-scene').appendChild(flash);
        setTimeout(() => flash.remove(), 250);

        oppSprite.classList.add('energy-suck');
        await new Promise(r => setTimeout(r, 400)); 
        oppSprite.style.opacity = '0';

        // 3. Drop & Bounce
        // Reset rotation visually
        ballVisual.style.transform = 'rotate(0deg)';
        spinAnim.cancel();

        // Animate Drop to "ground" (approx + 100px relative to sprite center? depends on sprite size)
        // Opponent sprite usually floats a bit. Let's drop it 60px down from center.
        const groundY = 60; 
        
        const dropAnim = ballContainer.animate([
            { transform: 'translate(0, 0)' },
            { transform: `translate(0, ${groundY}px)` }
        ], { 
            duration: 500, 
            easing: 'bounce', // Native bounce easing keyword not always avail, use cubic
            easing: 'cubic-bezier(0.6, 0.05, 0.9, 0.3)',
            fill: 'forwards'
        });
        
        await dropAnim.finished;
        ballContainer.style.top = (endY + groundY) + 'px'; // Update real top
        dropAnim.cancel(); // Clear transform
        
        // Bounce visual
        ballVisual.classList.add('ball-bounce');
        await new Promise(r => setTimeout(r, 400));
        ballVisual.classList.remove('ball-bounce');

        // 4. Shake Logic
        const hpFactor = (battleOpponent.maxHp - battleOpponent.hp) / battleOpponent.maxHp;
        const catchRate = 0.25 + (hpFactor * 0.5); 
        const isCaught = Math.random() < catchRate;
        
        let shakeCount = isCaught ? 3 : Math.floor(Math.random() * 3);
        ballLight.style.display = 'block'; 

        for(let i=1; i<=3; i++) {
             if (i > shakeCount && !isCaught) break;
             await new Promise(r => setTimeout(r, 600)); 
             ballVisual.className = 'ball-visual ' + (i % 2 === 0 ? 'shake-right' : 'shake-left');
             document.getElementById('battle-log').innerText = (i===1?".": (i===2?"..": "..."));
             ballLight.style.background = '#ff0000';
             ballLight.style.boxShadow = '0 0 8px red';
             await new Promise(r => setTimeout(r, 300)); 
             ballLight.style.background = '#880000'; 
             ballLight.style.boxShadow = 'none';
        }

        ballLight.style.display = 'none';
        ballVisual.className = 'ball-visual';

        // 5. Result
        if (isCaught) {
             document.getElementById('battle-log').innerText = `Gotcha! ${battleOpponent.name} capturado!`;
             ballVisual.style.filter = 'brightness(0.5)';
             
             for(let k=0; k<5; k++) {
                const star = document.createElement('div');
                star.innerHTML = '‚ú®';
                star.style.position = 'absolute';
                star.style.left = (endX + (Math.random()*40 - 20)) + 'px'; // Absolute relative to layer
                star.style.top = (endY + groundY + (Math.random()*40 - 20)) + 'px';
                star.style.fontSize = '16px';
                star.style.zIndex = '2100';
                star.style.animation = `critPop 0.8s forwards ${k*0.1}s`;
                layer.appendChild(star);
             }

             if (!myState.collection.includes(battleOpponent.name)) myState.collection.push(battleOpponent.name);
             if (battleOpponent.isShiny && !myState.shinies.includes(battleOpponent.name)) {
                  myState.shinies.push(battleOpponent.name);
             }
             addXP(40);
             await new Promise(r => setTimeout(r, 2000));
             endBattle();
        } else {
             document.getElementById('battle-log').innerText = "Ah n√£o! Escapou!";
             ballContainer.style.opacity = '0';
             oppSprite.classList.remove('energy-suck');
             oppSprite.style.opacity = '1';
             oppSprite.style.filter = 'brightness(100) white-drop-shadow(0 0 5px white)';
             
             await new Promise(r => setTimeout(r, 100));
             oppSprite.style.filter = 'none'; 
             
             await new Promise(r => setTimeout(r, 1500));
             layer.style.display = 'none';
             wildEnemyTurn();
        }
    };

    window.performRun = () => { 
        if(typeof battleOpponent === 'string') {
             const battleRef = doc(db, 'artifacts', appId, 'public', 'data', 'battles', battleOpponent);
             updateDoc(battleRef, { [`data_${currentUser.uid}.hp`]: 0, log: `${myState.nickname} desistiu.` });
        } else {
             endBattle(); 
        }
    };

    function endBattle() {
        activeBattle = false;
        if (battleOpponent?.el) battleOpponent.el.remove();
        document.getElementById('battle-overlay').style.display = 'none';
        
        const oppSprite = document.getElementById('opp-sprite');
        if(oppSprite) {
            oppSprite.style.transform = 'scale(1)';
            oppSprite.style.opacity = '1';
            oppSprite.className = 'poke-battle-img'; // reset
        }
        document.getElementById('capture-anim-layer').innerHTML = '';
        
        saveGame();
        battleOpponent = null;
        if(pvpSubscription) { pvpSubscription(); pvpSubscription = null; }
    }

    async function addXP(amount) {
        myState.xp += amount;
        while (myState.xp >= XP_PER_LEVEL) {
            myState.xp -= XP_PER_LEVEL;
            myState.level++;
            const nextForm = evolutionMap[myState.pokemon];
            const isStage0 = Object.keys(evolutionMap).includes(myState.pokemon); 
            const evoLevel = isStage0 ? 16 : 32;
            if (nextForm && myState.level >= evoLevel) {
                await triggerEvolution(nextForm);
            }
        }
        updateHUD();
        saveGame();
        updateCloudState();
    }

    async function triggerEvolution(newName) {
        const oldName = myState.pokemon;
        const isShiny = myState.shinies.includes(oldName);
        const overlay = document.getElementById('evo-overlay');
        const imgMain = document.getElementById('evo-img-main');
        const resultText = document.getElementById('evo-result');

        resultText.innerText = "O qu√™? " + oldName + " est√° a evoluir!";
        imgMain.src = getSprite(oldName, true, isShiny);
        imgMain.classList.remove('evo-pulse', 'evo-reveal');
        
        overlay.style.display = 'flex';
        
        await new Promise(r => setTimeout(r, 1000));
        
        imgMain.classList.add('evo-pulse');
        await new Promise(r => setTimeout(r, 2000)); 
        
        const flash = document.createElement('div');
        flash.className = 'white-flash-screen';
        overlay.appendChild(flash);
        
        await new Promise(r => setTimeout(r, 250));
        
        myState.pokemon = newName;
        if (!myState.collection.includes(newName)) myState.collection.push(newName);
        if (isShiny && !myState.shinies.includes(newName)) myState.shinies.push(newName);

        imgMain.src = getSprite(newName, true, isShiny);
        imgMain.classList.remove('evo-pulse');
        imgMain.classList.add('evo-reveal'); 
        
        await new Promise(r => setTimeout(r, 800)); 
        flash.remove();
        
        for(let i=0; i<30; i++) {
            const conf = document.createElement('div');
            conf.className = 'confetti';
            conf.style.left = Math.random() * 100 + '%';
            conf.style.top = -10 + 'px';
            conf.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
            conf.style.animationDuration = (1 + Math.random() * 2) + 's';
            overlay.appendChild(conf);
            setTimeout(() => conf.remove(), 3000);
        }

        resultText.innerText = `Parab√©ns! O teu ${oldName} evoluiu para ${newName}!`;
        
        await new Promise(r => setTimeout(r, 4000));
        overlay.style.display = 'none';
        
        syncView();
        updateCloudState();
    }
</script>
</body>
</html>
